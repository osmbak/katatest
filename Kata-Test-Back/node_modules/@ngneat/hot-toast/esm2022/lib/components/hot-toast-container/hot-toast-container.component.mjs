import { Component, ChangeDetectionStrategy, Input, ViewChildren } from '@angular/core';
import { Subject } from 'rxjs';
import { filter } from 'rxjs/operators';
import { HotToastComponent } from '../hot-toast/hot-toast.component';
import { HOT_TOAST_DEPTH_SCALE, HOT_TOAST_DEPTH_SCALE_ADD, HOT_TOAST_MARGIN } from '../../constants';
import * as i0 from "@angular/core";
export class HotToastContainerComponent {
    constructor(cdr) {
        this.cdr = cdr;
        this.toasts = [];
        this.toastRefs = [];
        this.isShowingAllToasts = false;
        /** Subject for notifying the user that the toast has been closed. */
        this._onClosed = new Subject();
        this.onClosed$ = this._onClosed.asObservable();
    }
    trackById(index, toast) {
        return toast.id;
    }
    getVisibleToasts(position) {
        return this.toasts.filter((t) => t.visible && t.position === position);
    }
    calculateOffset(toastId, position) {
        const visibleToasts = this.getVisibleToasts(position);
        const index = visibleToasts.findIndex((toast) => toast.id === toastId);
        const offset = index !== -1
            ? visibleToasts.slice(...(this.defaultConfig.reverseOrder ? [index + 1] : [0, index])).reduce((acc, t, i) => {
                const toastsAfter = visibleToasts.length - 1 - i;
                return this.defaultConfig.visibleToasts !== 0 && i < visibleToasts.length - this.defaultConfig.visibleToasts
                    ? 0
                    : acc +
                        (this.defaultConfig.stacking === 'vertical' || this.isShowingAllToasts
                            ? t.height || 0
                            : toastsAfter * HOT_TOAST_DEPTH_SCALE + HOT_TOAST_DEPTH_SCALE_ADD) +
                        HOT_TOAST_MARGIN;
            }, 0)
            : 0;
        return offset;
    }
    updateHeight(height, toast) {
        toast.height = height;
        this.cdr.detectChanges();
    }
    addToast(ref) {
        this.toastRefs.push(ref);
        const toast = ref.getToast();
        this.toasts.push(ref.getToast());
        if (this.defaultConfig.visibleToasts !== 0 && this.toasts.length > this.defaultConfig.visibleToasts) {
            const closeToasts = this.toasts.slice(0, this.toasts.length - this.defaultConfig.visibleToasts);
            closeToasts.forEach((t) => {
                if (t.autoClose) {
                    this.closeToast(t.id);
                }
            });
        }
        this.cdr.detectChanges();
        return {
            dispose: () => {
                this.closeToast(toast.id);
            },
            updateMessage: (message) => {
                toast.message = message;
                this.updateToasts(toast);
                this.cdr.detectChanges();
            },
            updateToast: (options) => {
                this.updateToasts(toast, options);
                this.cdr.detectChanges();
            },
            afterClosed: this.getAfterClosed(toast),
        };
    }
    closeToast(id) {
        if (id) {
            const comp = this.hotToastComponentList.find((item) => item.toast.id === id);
            if (comp) {
                comp.close();
            }
        }
        else {
            this.hotToastComponentList.forEach((comp) => comp.close());
        }
    }
    beforeClosed(toast) {
        toast.visible = false;
    }
    afterClosed(closeToast) {
        const toastIndex = this.toasts.findIndex((t) => t.id === closeToast.id);
        if (toastIndex > -1) {
            this._onClosed.next(closeToast);
            this.toasts = this.toasts.filter((t) => t.id !== closeToast.id);
            this.toastRefs = this.toastRefs.filter((t) => t.getToast().id !== closeToast.id);
            this.cdr.detectChanges();
        }
    }
    hasToast(id) {
        return this.toasts.findIndex((t) => t.id === id) > -1;
    }
    showAllToasts(show) {
        this.isShowingAllToasts = show;
    }
    getAfterClosed(toast) {
        return this.onClosed$.pipe(filter((v) => v.id === toast.id));
    }
    updateToasts(toast, options) {
        this.toasts = this.toasts.map((t) => ({ ...t, ...(t.id === toast.id && { ...toast, ...options }) }));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.1.3", ngImport: i0, type: HotToastContainerComponent, deps: [{ token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.1.3", type: HotToastContainerComponent, isStandalone: true, selector: "hot-toast-container", inputs: { defaultConfig: "defaultConfig" }, viewQueries: [{ propertyName: "hotToastComponentList", predicate: HotToastComponent, descendants: true }], ngImport: i0, template: "<div style=\"position: fixed; z-index: 9999; top: 0; right: 0; bottom: 0; left: 0; pointer-events: none\">\n  <div style=\"position: relative; height: 100%\">\n    <div>\n      @for (toast of toasts; track trackById(i, toast); let i = $index) {\n      <hot-toast\n        [toast]=\"toast\"\n        [offset]=\"calculateOffset(toast.id, toast.position)\"\n        [toastRef]=\"toastRefs[i]\"\n        [toastsAfter]=\"(toast.autoClose ? toasts.length : getVisibleToasts(toast.position).length) - 1 - i\"\n        [defaultConfig]=\"defaultConfig\"\n        [isShowingAllToasts]=\"isShowingAllToasts\"\n        (showAllToasts)=\"showAllToasts($event)\"\n        (height)=\"updateHeight($event, toast)\"\n        (beforeClosed)=\"beforeClosed(toast)\"\n        (afterClosed)=\"afterClosed($event)\"\n      ></hot-toast>\n      }\n    </div>\n  </div>\n</div>\n", dependencies: [{ kind: "component", type: HotToastComponent, selector: "hot-toast", inputs: ["toast", "offset", "defaultConfig", "toastRef", "toastsAfter", "isShowingAllToasts"], outputs: ["height", "beforeClosed", "afterClosed", "showAllToasts"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, preserveWhitespaces: true }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.1.3", ngImport: i0, type: HotToastContainerComponent, decorators: [{
            type: Component,
            args: [{ selector: 'hot-toast-container', changeDetection: ChangeDetectionStrategy.OnPush, standalone: true, imports: [HotToastComponent], template: "<div style=\"position: fixed; z-index: 9999; top: 0; right: 0; bottom: 0; left: 0; pointer-events: none\">\n  <div style=\"position: relative; height: 100%\">\n    <div>\n      @for (toast of toasts; track trackById(i, toast); let i = $index) {\n      <hot-toast\n        [toast]=\"toast\"\n        [offset]=\"calculateOffset(toast.id, toast.position)\"\n        [toastRef]=\"toastRefs[i]\"\n        [toastsAfter]=\"(toast.autoClose ? toasts.length : getVisibleToasts(toast.position).length) - 1 - i\"\n        [defaultConfig]=\"defaultConfig\"\n        [isShowingAllToasts]=\"isShowingAllToasts\"\n        (showAllToasts)=\"showAllToasts($event)\"\n        (height)=\"updateHeight($event, toast)\"\n        (beforeClosed)=\"beforeClosed(toast)\"\n        (afterClosed)=\"afterClosed($event)\"\n      ></hot-toast>\n      }\n    </div>\n  </div>\n</div>\n" }]
        }], ctorParameters: () => [{ type: i0.ChangeDetectorRef }], propDecorators: { defaultConfig: [{
                type: Input
            }], hotToastComponentList: [{
                type: ViewChildren,
                args: [HotToastComponent]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LWNvbnRhaW5lci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ25lYXQvaG90LXRvYXN0L3NyYy9saWIvY29tcG9uZW50cy9ob3QtdG9hc3QtY29udGFpbmVyL2hvdC10b2FzdC1jb250YWluZXIuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2hvdC10b2FzdC9zcmMvbGliL2NvbXBvbmVudHMvaG90LXRvYXN0LWNvbnRhaW5lci9ob3QtdG9hc3QtY29udGFpbmVyLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsdUJBQXVCLEVBQXFCLEtBQUssRUFBYSxZQUFZLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdEgsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVcvQixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFeEMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDckUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLHlCQUF5QixFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7O0FBU3JHLE1BQU0sT0FBTywwQkFBMEI7SUFjckMsWUFBb0IsR0FBc0I7UUFBdEIsUUFBRyxHQUFILEdBQUcsQ0FBbUI7UUFUMUMsV0FBTSxHQUFxQixFQUFFLENBQUM7UUFDOUIsY0FBUyxHQUFpQyxFQUFFLENBQUM7UUFDN0MsdUJBQWtCLEdBQUcsS0FBSyxDQUFDO1FBRTNCLHFFQUFxRTtRQUM3RCxjQUFTLEdBQUcsSUFBSSxPQUFPLEVBQWlCLENBQUM7UUFFekMsY0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7SUFFTCxDQUFDO0lBRTlDLFNBQVMsQ0FBQyxL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QyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFTyxZQUFZLENBQUMsS0FBcUIsRUFBRSxPQUFxQztRQUMvRSxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLEdBQUcsS0FBSyxFQUFFLEdBQUcsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN2RyxDQUFDOzhHQXpIVSwwQkFBMEI7a0dBQTFCLDBCQUEwQixxS0FHdkIsaUJBQWlCLGdEQzNCakMseTFCQW9CQSw0Q0RFWSxpQkFBaUI7OzJGQUVoQiwwQkFBMEI7a0JBUHRDLFNBQVM7K0JBQ0UscUJBQXFCLG1CQUVkLHVCQUF1QixDQUFDLE1BQU0sY0FDbkMsSUFBSSxXQUNQLENBQUMsaUJBQWlCLENBQUM7c0ZBR25CLGFBQWE7c0JBQXJCLEtBQUs7Z0JBRTJCLHFCQUFxQjtzQkFBckQsWUFBWTt1QkFBQyxpQkFBaUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LCBDaGFuZ2VEZXRlY3RvclJlZiwgSW5wdXQsIFF1ZXJ5TGlzdCwgVmlld0NoaWxkcmVuIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBIb3RUb2FzdENsb3NlLFxuICBUb2FzdCxcbiAgVG9hc3RDb25maWcsXG4gIFRvYXN0UG9zaXRpb24sXG4gIFVwZGF0ZVRvYXN0T3B0aW9ucyxcbiAgQWRkVG9hc3RSZWYsXG4gIENyZWF0ZUhvdFRvYXN0UmVmLFxufSBmcm9tICcuLi8uLi9ob3QtdG9hc3QubW9kZWwnO1xuaW1wb3J0IHsgSG90VG9hc3RSZWYgfSBmcm9tICcuLi8uLi9ob3QtdG9hc3QtcmVmJztcbmltcG9ydCB7IGZpbHRlciB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvbnRlbnQgfSBmcm9tICdAbmduZWF0L292ZXJ2aWV3JztcbmltcG9ydCB7IEhvdFRvYXN0Q29tcG9uZW50IH0gZnJvbSAnLi4vaG90LXRvYXN0L2hvdC10b2FzdC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSE9UX1RPQVNUX0RFUFRIX1NDQUxFLCBIT1RfVE9BU1RfREVQVEhfU0NBTEVfQURELCBIT1RfVE9BU1RfTUFSR0lOIH0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaG90LXRvYXN0LWNvbnRhaW5lcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9ob3QtdG9hc3QtY29udGFpbmVyLmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG4gIHN0YW5kYWxvbmU6IHRydWUsXG4gIGltcG9ydHM6IFtIb3RUb2FzdENvbXBvbmVudF0sXG59KVxuZXhwb3J0IGNsYXNzIEhvdFRvYXN0Q29udGFpbmVyQ29tcG9uZW50IHtcbiAgQElucHV0KCkgZGVmYXVsdENvbmZpZzogVG9hc3RDb25maWc7XG5cbiAgQFZpZXdDaGlsZHJlbihIb3RUb2FzdENvbXBvbmVudCkgaG90VG9hc3RDb21wb25lbnRMaXN0OiBRdWVyeUxpc3Q8SG90VG9hc3RDb21wb25lbnQ+O1xuXG4gIHRvYXN0czogVG9hc3Q8dW5rbm93bj5bXSA9IFtdO1xuICB0b2FzdFJlZnM6IENyZWF0ZUhvdFRvYXN0UmVmPHVua25vd24+W10gPSBbXTtcbiAgaXNTaG93aW5nQWxsVG9hc3RzID0gZmFsc2U7XG5cbiAgLyoqIFN1YmplY3QgZm9yIG5vdGlmeWluZyB0aGUgdXNlciB0aGF0IHRoZSB0b2FzdCBoYXMgYmVlbiBjbG9zZWQuICovXG4gIHByaXZhdGUgX29uQ2xvc2VkID0gbmV3IFN1YmplY3Q8SG90VG9hc3RDbG9zZT4oKTtcblxuICBwcml2YXRlIG9uQ2xvc2VkJCA9IHRoaXMuX29uQ2xvc2VkLmFzT2JzZXJ2YWJsZSgpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZikge31cblxuICB0cmFja0J5SWQoaW5kZXg6IG51bWJlciwgdG9hc3Q6IFRvYXN0PHVua25vd24+KSB7XG4gICAgcmV0dXJuIHRvYXN0LmlkO1xuICB9XG5cbiAgZ2V0VmlzaWJsZVRvYXN0cyhwb3NpdGlvbjogVG9hc3RQb3NpdGlvbikge1xuICAgIHJldHVybiB0aGlzLnRvYXN0cy5maWx0ZXIoKHQpID0+IHQudmlzaWJsZSAmJiB0LnBvc2l0aW9uID09PSBwb3NpdGlvbik7XG4gIH1cbiAgY2FsY3VsYXRlT2Zmc2V0KHRvYXN0SWQ6IHN0cmluZywgcG9zaXRpb246IFRvYXN0UG9zaXRpb24pIHtcbiAgICBjb25zdCB2aXNpYmxlVG9hc3RzID0gdGhpcy5nZXRWaXNpYmxlVG9hc3RzKHBvc2l0aW9uKTtcbiAgICBjb25zdCBpbmRleCA9IHZpc2libGVUb2FzdHMuZmluZEluZGV4KCh0b2FzdCkgPT4gdG9hc3QuaWQgPT09IHRvYXN0SWQpO1xuICAgIGNvbnN0IG9mZnNldCA9XG4gICAgICBpbmRleCAhPT0gLTFcbiAgICAgICAgPyB2aXNpYmxlVG9hc3RzLnNsaWNlKC4uLih0aGlzLmRlZmF1bHRDb25maWcucmV2ZXJzZU9yZGVyID8gW2luZGV4ICsgMV0gOiBbMCwgaW5kZXhdKSkucmVkdWNlKChhY2MsIHQsIGkpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRvYXN0c0FmdGVyID0gdmlzaWJsZVRvYXN0cy5sZW5ndGggLSAxIC0gaTtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmRlZmF1bHRDb25maWcudmlzaWJsZVRvYXN0cyAhPT0gMCAmJiBpIDwgdmlzaWJsZVRvYXN0cy5sZW5ndGggLSB0aGlzLmRlZmF1bHRDb25maWcudmlzaWJsZVRvYXN0c1xuICAgICAgICAgICAgICA/IDBcbiAgICAgICAgICAgICAgOiBhY2MgK1xuICAgICAgICAgICAgICAgICAgKHRoaXMuZGVmYXVsdENvbmZpZy5zdGFja2luZyA9PT0gJ3ZlcnRpY2FsJyB8fCB0aGlzLmlzU2hvd2luZ0FsbFRvYXN0c1xuICAgICAgICAgICAgICAgICAgICA/IHQuaGVpZ2h0IHx8IDBcbiAgICAgICAgICAgICAgICAgICAgOiB0b2FzdHNBZnRlciAqIEhPVF9UT0FTVF9ERVBUSF9TQ0FMRSArIEhPVF9UT0FTVF9ERVBUSF9TQ0FMRV9BREQpICtcbiAgICAgICAgICAgICAgICAgIEhPVF9UT0FTVF9NQVJHSU47XG4gICAgICAgICAgfSwgMClcbiAgICAgICAgOiAwO1xuICAgIHJldHVybiBvZmZzZXQ7XG4gIH1cblxuICB1cGRhdGVIZWlnaHQoaGVpZ2h0OiBudW1iZXIsIHRvYXN0OiBUb2FzdDx1bmtub3duPikge1xuICAgIHRvYXN0LmhlaWdodCA9IGhlaWdodDtcbiAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBhZGRUb2FzdDxEYXRhVHlwZT4ocmVmOiBIb3RUb2FzdFJlZik6IEFkZFRvYXN0UmVmPERhdGFUeXBlPiB7XG4gICAgdGhpcy50b2FzdFJlZnMucHVzaChyZWYpO1xuXG4gICAgY29uc3QgdG9hc3QgPSByZWYuZ2V0VG9hc3QoKTtcblxuICAgIHRoaXMudG9hc3RzLnB1c2gocmVmLmdldFRvYXN0KCkpO1xuXG4gICAgaWYgKHRoaXMuZGVmYXVsdENvbmZpZy52aXNpYmxlVG9hc3RzICE9PSAwICYmIHRoaXMudG9hc3RzLmxlbmd0aCA+IHRoaXMuZGVmYXVsdENvbmZpZy52aXNpYmxlVG9hc3RzKSB7XG4gICAgICBjb25zdCBjbG9zZVRvYXN0cyA9IHRoaXMudG9hc3RzLnNsaWNlKDAsIHRoaXMudG9hc3RzLmxlbmd0aCAtIHRoaXMuZGVmYXVsdENvbmZpZy52aXNpYmxlVG9hc3RzKTtcbiAgICAgIGNsb3NlVG9hc3RzLmZvckVhY2goKHQpID0+IHtcbiAgICAgICAgaWYgKHQuYXV0b0Nsb3NlKSB7XG4gICAgICAgICAgdGhpcy5jbG9zZVRvYXN0KHQuaWQpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgZGlzcG9zZTogKCkgPT4ge1xuICAgICAgICB0aGlzLmNsb3NlVG9hc3QodG9hc3QuaWQpO1xuICAgICAgfSxcbiAgICAgIHVwZGF0ZU1lc3NhZ2U6IChtZXNzYWdlOiBDb250ZW50KSA9PiB7XG4gICAgICAgIHRvYXN0Lm1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgICB0aGlzLnVwZGF0ZVRvYXN0cyh0b2FzdCk7XG4gICAgICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgICAgIH0sXG4gICAgICB1cGRhdGVUb2FzdDogKG9wdGlvbnM6IFVwZGF0ZVRvYXN0T3B0aW9uczxEYXRhVHlwZT4pID0+IHtcbiAgICAgICAgdGhpcy51cGRhdGVUb2FzdHModG9hc3QsIG9wdGlvbnMpO1xuICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICB9LFxuICAgICAgYWZ0ZXJDbG9zZWQ6IHRoaXMuZ2V0QWZ0ZXJDbG9zZWQodG9hc3QpLFxuICAgIH07XG4gIH1cblxuICBjbG9zZVRvYXN0KGlkPzogc3RyaW5nKSB7XG4gICAgaWYgKGlkKSB7XG4gICAgICBjb25zdCBjb21wID0gdGhpcy5ob3RUb2FzdENvbXBvbmVudExpc3QuZmluZCgoaXRlbSkgPT4gaXRlbS50b2FzdC5pZCA9PT0gaWQpO1xuICAgICAgaWYgKGNvbXApIHtcbiAgICAgICAgY29tcC5jbG9zZSgpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmhvdFRvYXN0Q29tcG9uZW50TGlzdC5mb3JFYWNoKChjb21wKSA9PiBjb21wLmNsb3NlKCkpO1xuICAgIH1cbiAgfVxuXG4gIGJlZm9yZUNsb3NlZCh0b2FzdDogVG9hc3Q8dW5rbm93bj4pIHtcbiAgICB0b2FzdC52aXNpYmxlID0gZmFsc2U7XG4gIH1cblxuICBhZnRlckNsb3NlZChjbG9zZVRvYXN0OiBIb3RUb2FzdENsb3NlKSB7XG4gICAgY29uc3QgdG9hc3RJbmRleCA9IHRoaXMudG9hc3RzLmZpbmRJbmRleCgodCkgPT4gdC5pZCA9PT0gY2xvc2VUb2FzdC5pZCk7XG4gICAgaWYgKHRvYXN0SW5kZXggPiAtMSkge1xuICAgICAgdGhpcy5fb25DbG9zZWQubmV4dChjbG9zZVRvYXN0KTtcbiAgICAgIHRoaXMudG9hc3RzID0gdGhpcy50b2FzdHMuZmlsdGVyKCh0KSA9PiB0LmlkICE9PSBjbG9zZVRvYXN0LmlkKTtcbiAgICAgIHRoaXMudG9hc3RSZWZzID0gdGhpcy50b2FzdFJlZnMuZmlsdGVyKCh0KSA9PiB0LmdldFRvYXN0KCkuaWQgIT09IGNsb3NlVG9hc3QuaWQpO1xuICAgICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIGhhc1RvYXN0KGlkOiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy50b2FzdHMuZmluZEluZGV4KCh0KSA9PiB0LmlkID09PSBpZCkgPiAtMTtcbiAgfVxuXG4gIHNob3dBbGxUb2FzdHMoc2hvdzogYm9vbGVhbikge1xuICAgIHRoaXMuaXNTaG93aW5nQWxsVG9hc3RzID0gc2hvdztcbiAgfVxuXG4gIHByaXZhdGUgZ2V0QWZ0ZXJDbG9zZWQodG9hc3Q6IFRvYXN0PHVua25vd24+KSB7XG4gICAgcmV0dXJuIHRoaXMub25DbG9zZWQkLnBpcGUoZmlsdGVyKCh2KSA9PiB2LmlkID09PSB0b2FzdC5pZCkpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVUb2FzdHModG9hc3Q6IFRvYXN0PHVua25vd24+LCBvcHRpb25zPzogVXBkYXRlVG9hc3RPcHRpb25zPHVua25vd24+KSB7XG4gICAgdGhpcy50b2FzdHMgPSB0aGlzLnRvYXN0cy5tYXAoKHQpID0+ICh7IC4uLnQsIC4uLih0LmlkID09PSB0b2FzdC5pZCAmJiB7IC4uLnRvYXN0LCAuLi5vcHRpb25zIH0pIH0pKTtcbiAgfVxufVxuIiwiPGRpdiBzdHlsZT1cInBvc2l0aW9uOiBmaXhlZDsgei1pbmRleDogOTk5OTsgdG9wOiAwOyByaWdodDogMDsgYm90dG9tOiAwOyBsZWZ0OiAwOyBwb2ludGVyLWV2ZW50czogbm9uZVwiPlxuICA8ZGl2IHN0eWxlPVwicG9zaXRpb246IHJlbGF0aXZlOyBoZWlnaHQ6IDEwMCVcIj5cbiAgICA8ZGl2PlxuICAgICAgQGZvciAodG9hc3Qgb2YgdG9hc3RzOyB0cmFjayB0cmFja0J5SWQoaSwgdG9hc3QpOyBsZXQgaSA9ICRpbmRleCkge1xuICAgICAgPGhvdC10b2FzdFxuICAgICAgICBbdG9hc3RdPVwidG9hc3RcIlxuICAgICAgICBbb2Zmc2V0XT1cImNhbGN1bGF0ZU9mZnNldCh0b2FzdC5pZCwgdG9hc3QucG9zaXRpb24pXCJcbiAgICAgICAgW3RvYXN0UmVmXT1cInRvYXN0UmVmc1tpXVwiXG4gICAgICAgIFt0b2FzdHNBZnRlcl09XCIodG9hc3QuYXV0b0Nsb3NlID8gdG9hc3RzLmxlbmd0aCA6IGdldFZpc2libGVUb2FzdHModG9hc3QucG9zaXRpb24pLmxlbmd0aCkgLSAxIC0gaVwiXG4gICAgICAgIFtkZWZhdWx0Q29uZmlnXT1cImRlZmF1bHRDb25maWdcIlxuICAgICAgICBbaXNTaG93aW5nQWxsVG9hc3RzXT1cImlzU2hvd2luZ0FsbFRvYXN0c1wiXG4gICAgICAgIChzaG93QWxsVG9hc3RzKT1cInNob3dBbGxUb2FzdHMoJGV2ZW50KVwiXG4gICAgICAgIChoZWlnaHQpPVwidXBkYXRlSGVpZ2h0KCRldmVudCwgdG9hc3QpXCJcbiAgICAgICAgKGJlZm9yZUNsb3NlZCk9XCJiZWZvcmVDbG9zZWQodG9hc3QpXCJcbiAgICAgICAgKGFmdGVyQ2xvc2VkKT1cImFmdGVyQ2xvc2VkKCRldmVudClcIlxuICAgICAgPjwvaG90LXRvYXN0PlxuICAgICAgfVxuICAgIDwvZGl2PlxuICA8L2Rpdj5cbjwvZGl2PlxuIl19