import { ChangeDetectionStrategy, Component, EventEmitter, Injector, Input, Output, ViewChild, } from '@angular/core';
import { CommonModule } from '@angular/common';
import { DynamicViewDirective, isComponent, isTemplateRef } from '@ngneat/overview';
import { ENTER_ANIMATION_DURATION, EXIT_ANIMATION_DURATION, HOT_TOAST_DEPTH_SCALE, } from '../../constants';
import { HotToastRef } from '../../hot-toast-ref';
import { animate } from '../../utils';
import { IndicatorComponent } from '../indicator/indicator.component';
import { AnimatedIconComponent } from '../animated-icon/animated-icon.component';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
export class HotToastComponent {
    get toastsAfter() {
        return this._toastsAfter;
    }
    set toastsAfter(value) {
        this._toastsAfter = value;
        if (this.defaultConfig?.visibleToasts > 0) {
            if (this.toast.autoClose) {
                // if (value >= this.defaultConfig?.visibleToasts) {
                //   this.close();
                // }
            }
            else {
                if (value >= this.defaultConfig?.visibleToasts) {
                    this.softClose();
                }
                else if (this.softClosed) {
                    this.softOpen();
                }
            }
        }
    }
    constructor(injector, renderer, ngZone) {
        this.injector = injector;
        this.renderer = renderer;
        this.ngZone = ngZone;
        this.offset = 0;
        this._toastsAfter = 0;
        this.isShowingAllToasts = false;
        this.height = new EventEmitter();
        this.beforeClosed = new EventEmitter();
        this.afterClosed = new EventEmitter();
        this.showAllToasts = new EventEmitter();
        this.isManualClose = false;
        this.unlisteners = [];
        this.softClosed = false;
    }
    get toastBarBaseHeight() {
        return this.toastBarBase.nativeElement.offsetHeight;
    }
    get scale() {
        return this.defaultConfig.stacking !== 'vertical' && !this.isShowingAllToasts
            ? this.toastsAfter * -HOT_TOAST_DEPTH_SCALE + 1
            : 1;
    }
    get translateY() {
        return this.offset * (this.top ? 1 : -1) + 'px';
    }
    get exitAnimationDelay() {
        return this.toast.duration + 'ms';
    }
    get top() {
        return this.toast.position.includes('top');
    }
    get containerPositionStyle() {
        const verticalStyle = this.top ? { top: 0 } : { bottom: 0 };
        const transform = `translateY(var(--hot-toast-translate-y)) scale(var(--hot-toast-scale))`;
        const horizontalStyle = this.toast.position.includes('left')
            ? {
                left: 0,
            }
            : this.toast.position.includes('right')
                ? {
                    right: 0,
                }
                : {
                    left: 0,
                    right: 0,
                    justifyContent: 'center',
                };
        return {
            transform,
            ...verticalStyle,
            ...horizontalStyle,
        };
    }
    get toastBarBaseStyles() {
        const enterAnimation = `hotToastEnterAnimation${this.top ? 'Negative' : 'Positive'} ${ENTER_ANIMATION_DURATION}ms cubic-bezier(0.21, 1.02, 0.73, 1) forwards`;
        const exitAnimation = `hotToastExitAnimation${this.top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1) var(--hot-toast-exit-animation-delay) var(--hot-toast-exit-animation-state)`;
        const animation = this.toast.autoClose ? `${enterAnimation}, ${exitAnimation}` : enterAnimation;
        return { ...this.toast.style, animation };
    }
    get isIconString() {
        return typeof this.toast.icon === 'string';
    }
    ngOnChanges(changes) {
        if (changes.toast && !changes.toast.firstChange && changes.toast.currentValue?.message) {
            requestAnimationFrame(() => {
                this.height.emit(this.toastBarBase.nativeElement.offsetHeight);
            });
        }
    }
    ngOnInit() {
        if (isTemplateRef(this.toast.message)) {
            this.context = { $implicit: this.toastRef };
        }
        if (isComponent(this.toast.message)) {
            this.toastComponentInjector = Injector.create({
                providers: [
                    {
                        provide: HotToastRef,
                        useValue: this.toastRef,
                    },
                ],
                parent: this.toast.injector || this.injector,
            });
        }
    }
    ngAfterViewInit() {
        const nativeElement = this.toastBarBase.nativeElement;
        // Caretaker note: accessing `offsetHeight` triggers the whole layout update.
        // Macro tasks (like `setTimeout`) might be executed within the current rendering frame and cause a frame drop.
        requestAnimationFrame(() => {
            this.height.emit(nativeElement.offsetHeight);
        });
        // Caretaker note: `animationstart` and `animationend` events are event tasks that trigger change detection.
        // We'd want to trigger the change detection only if it's an exit animation.
        this.ngZone.runOutsideAngular(() => {
            this.unlisteners.push(
            // Caretaker note: we have to remove these event listeners at the end (even if the element is removed from DOM).
            // zone.js stores its `ZoneTask`s within the `nativeElement[Zone.__symbol__('animationstart') + 'false']` property
            // with callback that capture `this`.
            this.renderer.listen(nativeElement, 'animationstart', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.beforeClosed.emit());
                }
            }), this.renderer.listen(nativeElement, 'animationend', (event) => {
                if (this.isExitAnimation(event)) {
                    this.ngZone.run(() => this.afterClosed.emit({ dismissedByAction: this.isManualClose, id: this.toast.id }));
                }
            }));
        });
        this.setToastAttributes();
    }
    softClose() {
        const exitAnimation = `hotToastExitSoftAnimation${this.top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1)`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, exitAnimation);
        this.softClosed = true;
    }
    softOpen() {
        const softEnterAnimation = `hotToastEnterSoftAnimation${top ? 'Negative' : 'Positive'} ${ENTER_ANIMATION_DURATION}ms cubic-bezier(0.21, 1.02, 0.73, 1) forwards`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, softEnterAnimation);
        this.softClosed = false;
    }
    close() {
        this.isManualClose = true;
        const exitAnimation = `hotToastExitAnimation${this.top ? 'Negative' : 'Positive'} ${EXIT_ANIMATION_DURATION}ms forwards cubic-bezier(0.06, 0.71, 0.55, 1)`;
        const nativeElement = this.toastBarBase.nativeElement;
        animate(nativeElement, exitAnimation);
    }
    handleMouseEnter() {
        this.showAllToasts.emit(true);
    }
    handleMouseLeave() {
        this.showAllToasts.emit(false);
    }
    ngOnDestroy() {
        this.close();
        while (this.unlisteners.length) {
            this.unlisteners.pop()();
        }
    }
    isExitAnimation(ev) {
        return ev.animationName.includes('hotToastExitAnimation');
    }
    setToastAttributes() {
        const toastAttributes = this.toast.attributes;
        for (const [key, value] of Object.entries(toastAttributes)) {
            this.renderer.setAttribute(this.toastBarBase.nativeElement, key, value);
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.1.3", ngImport: i0, type: HotToastComponent, deps: [{ token: i0.Injector }, { token: i0.Renderer2 }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.0.0", version: "17.1.3", type: HotToastComponent, isStandalone: true, selector: "hot-toast", inputs: { toast: "toast", offset: "offset", defaultConfig: "defaultConfig", toastRef: "toastRef", toastsAfter: "toastsAfter", isShowingAllToasts: "isShowingAllToasts" }, outputs: { height: "height", beforeClosed: "beforeClosed", afterClosed: "afterClosed", showAllToasts: "showAllToasts" }, viewQueries: [{ propertyName: "toastBarBase", first: true, predicate: ["hotToastBarBase"], descendants: true }], usesOnChanges: true, ngImport: i0, template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n  [style.--hot-toast-scale]=\"scale\"\n  [style.--hot-toast-translate-y]=\"translateY\"\n>\n  <div class=\"hot-toast-bar-base-wrapper\" (mouseenter)=\"handleMouseEnter()\" (mouseleave)=\"handleMouseLeave()\">\n    <div\n      class=\"hot-toast-bar-base\"\n      #hotToastBarBase\n      [ngStyle]=\"toastBarBaseStyles\"\n      [ngClass]=\"toast.className\"\n      [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n      [style.--hot-toast-exit-animation-state]=\"isShowingAllToasts ? 'paused' : 'running'\"\n      [style.--hot-toast-exit-animation-delay]=\"exitAnimationDelay\"\n      [attr.aria-live]=\"toast.ariaLive\"\n      [attr.role]=\"toast.role\"\n    >\n      <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n        @if (toast.icon !== undefined) { @if (isIconString) {\n        <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n        } @else {\n        <div>\n          <ng-container *dynamicView=\"toast.icon\"></ng-container>\n        </div>\n        } } @else {\n        <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n        }\n      </div>\n\n      <div class=\"hot-toast-message\">\n        <div>\n          <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n        </div>\n      </div>\n\n      @if (toast.dismissible) {\n      <button\n        (click)=\"close()\"\n        type=\"button\"\n        class=\"hot-toast-close-btn\"\n        aria-label=\"Close\"\n        [ngStyle]=\"toast.closeStyle\"\n      ></button>\n      }\n    </div>\n  </div>\n</div>\n", dependencies: [{ kind: "ngmodule", type: CommonModule }, { kind: "directive", type: i1.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i1.NgStyle, selector: "[ngStyle]", inputs: ["ngStyle"] }, { kind: "directive", type: DynamicViewDirective, selector: "[dynamicView]", inputs: ["dynamicView", "dynamicViewInjector", "dynamicViewContext", "dynamicViewInputs"] }, { kind: "component", type: IndicatorComponent, selector: "hot-toast-indicator", inputs: ["theme", "type"] }, { kind: "component", type: AnimatedIconComponent, selector: "hot-toast-animated-icon", inputs: ["iconTheme"] }], changeDetection: i0.ChangeDetectionStrategy.OnPush, preserveWhitespaces: true }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.1.3", ngImport: i0, type: HotToastComponent, decorators: [{
            type: Component,
            args: [{ selector: 'hot-toast', changeDetection: ChangeDetectionStrategy.OnPush, standalone: true, imports: [CommonModule, DynamicViewDirective, IndicatorComponent, AnimatedIconComponent], template: "<div\n  class=\"hot-toast-bar-base-container\"\n  [ngStyle]=\"containerPositionStyle\"\n  [ngClass]=\"'hot-toast-theme-' + toast.theme\"\n  [style.--hot-toast-scale]=\"scale\"\n  [style.--hot-toast-translate-y]=\"translateY\"\n>\n  <div class=\"hot-toast-bar-base-wrapper\" (mouseenter)=\"handleMouseEnter()\" (mouseleave)=\"handleMouseLeave()\">\n    <div\n      class=\"hot-toast-bar-base\"\n      #hotToastBarBase\n      [ngStyle]=\"toastBarBaseStyles\"\n      [ngClass]=\"toast.className\"\n      [style.--hot-toast-animation-state]=\"isManualClose ? 'running' : 'paused'\"\n      [style.--hot-toast-exit-animation-state]=\"isShowingAllToasts ? 'paused' : 'running'\"\n      [style.--hot-toast-exit-animation-delay]=\"exitAnimationDelay\"\n      [attr.aria-live]=\"toast.ariaLive\"\n      [attr.role]=\"toast.role\"\n    >\n      <div class=\"hot-toast-icon\" aria-hidden=\"true\">\n        @if (toast.icon !== undefined) { @if (isIconString) {\n        <hot-toast-animated-icon [iconTheme]=\"toast.iconTheme\">{{ toast.icon }}</hot-toast-animated-icon>\n        } @else {\n        <div>\n          <ng-container *dynamicView=\"toast.icon\"></ng-container>\n        </div>\n        } } @else {\n        <hot-toast-indicator [theme]=\"toast.iconTheme\" [type]=\"toast.type\"></hot-toast-indicator>\n        }\n      </div>\n\n      <div class=\"hot-toast-message\">\n        <div>\n          <ng-container *dynamicView=\"toast.message; context: context; injector: toastComponentInjector\"></ng-container>\n        </div>\n      </div>\n\n      @if (toast.dismissible) {\n      <button\n        (click)=\"close()\"\n        type=\"button\"\n        class=\"hot-toast-close-btn\"\n        aria-label=\"Close\"\n        [ngStyle]=\"toast.closeStyle\"\n      ></button>\n      }\n    </div>\n  </div>\n</div>\n" }]
        }], ctorParameters: () => [{ type: i0.Injector }, { type: i0.Renderer2 }, { type: i0.NgZone }], propDecorators: { toast: [{
                type: Input
            }], offset: [{
                type: Input
            }], defaultConfig: [{
                type: Input
            }], toastRef: [{
                type: Input
            }], toastsAfter: [{
                type: Input
            }], isShowingAllToasts: [{
                type: Input
            }], height: [{
                type: Output
            }], beforeClosed: [{
                type: Output
            }], afterClosed: [{
                type: Output
            }], showAllToasts: [{
                type: Output
            }], toastBarBase: [{
                type: ViewChild,
                args: ['hotToastBarBase']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90LXRvYXN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nbmVhdC9ob3QtdG9hc3Qvc3JjL2xpYi9jb21wb25lbnRzL2hvdC10b2FzdC9ob3QtdG9hc3QuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2hvdC10b2FzdC9zcmMvbGliL2NvbXBvbmVudHMvaG90LXRvYXN0L2hvdC10b2FzdC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFFVCxZQUFZLEVBQ1osUUFBUSxFQUNSLEtBQUssRUFLTCxNQUFNLEVBR04sU0FBUyxHQUNWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMvQyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsV0FBVyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRXBGLE9BQU8sRUFDTCx3QkFBd0IsRUFDeEIsdUJBQXVCLEVBQ3ZCLHFCQUFxQixHQUN0QixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUVsRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3RFLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDBDQUEwQyxDQUFDOzs7QUFTakYsTUFBTSxPQUFPLGlCQUFpQjtJQU01QixJQUFJLFdBQVc7UUFDYixPQUFPLElBQUksQ0FBQyxZQUFZLENBQUM7SUFDM0IsQ0FBQztJQUNELElBQ0ksV0FBVyxDQUFDLEtBQUs7UUFDbkIsSUFBSSxDQUFDLFlBQVksR0FBRyxLQUFLLENBQUM7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RUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDekU7SUFDSCxDQUFDOzhHQTVOVSxpQkFBaUI7a0dBQWpCLGlCQUFpQiw4ZUN0QzlCLG14REFpREEsMkNEYlksWUFBWSxrTkFBRSxvQkFBb0IscUpBQUUsa0JBQWtCLDJGQUFFLHFCQUFxQjs7MkZBRTVFLGlCQUFpQjtrQkFQN0IsU0FBUzsrQkFDRSxXQUFXLG1CQUVKLHVCQUF1QixDQUFDLE1BQU0sY0FDbkMsSUFBSSxXQUNQLENBQUMsWUFBWSxFQUFFLG9CQUFvQixFQUFFLGtCQUFrQixFQUFFLHFCQUFxQixDQUFDOzBIQUcvRSxLQUFLO3NCQUFiLEtBQUs7Z0JBQ0csTUFBTTtzQkFBZCxLQUFLO2dCQUNHLGFBQWE7c0JBQXJCLEtBQUs7Z0JBQ0csUUFBUTtzQkFBaEIsS0FBSztnQkFNRixXQUFXO3NCQURkLEtBQUs7Z0JBaUJHLGtCQUFrQjtzQkFBMUIsS0FBSztnQkFFSSxNQUFNO3NCQUFmLE1BQU07Z0JBQ0csWUFBWTtzQkFBckIsTUFBTTtnQkFDRyxXQUFXO3NCQUFwQixNQUFNO2dCQUNHLGFBQWE7c0JBQXRCLE1BQU07Z0JBRStCLFlBQVk7c0JBQWpELFNBQVM7dUJBQUMsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgRXZlbnRFbWl0dGVyLFxuICBJbmplY3RvcixcbiAgSW5wdXQsXG4gIE5nWm9uZSxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbiAgT3V0cHV0LFxuICBSZW5kZXJlcjIsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIFZpZXdDaGlsZCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBDb21tb25Nb2R1bGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgRHluYW1pY1ZpZXdEaXJlY3RpdmUsIGlzQ29tcG9uZW50LCBpc1RlbXBsYXRlUmVmIH0gZnJvbSAnQG5nbmVhdC9vdmVydmlldyc7XG5cbmltcG9ydCB7XG4gIEVOVEVSX0FOSU1BVElPTl9EVVJBVElPTixcbiAgRVhJVF9BTklNQVRJT05fRFVSQVRJT04sXG4gIEhPVF9UT0FTVF9ERVBUSF9TQ0FMRSxcbn0gZnJvbSAnLi4vLi4vY29uc3RhbnRzJztcbmltcG9ydCB7IEhvdFRvYXN0UmVmIH0gZnJvbSAnLi4vLi4vaG90LXRvYXN0LXJlZic7XG5pbXBvcnQgeyBDcmVhdGVIb3RUb2FzdFJlZiwgSG90VG9hc3RDbG9zZSwgVG9hc3QsIFRvYXN0Q29uZmlnIH0gZnJvbSAnLi4vLi4vaG90LXRvYXN0Lm1vZGVsJztcbmltcG9ydCB7IGFuaW1hdGUgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBJbmRpY2F0b3JDb21wb25lbnQgfSBmcm9tICcuLi9pbmRpY2F0b3IvaW5kaWNhdG9yLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBBbmltYXRlZEljb25Db21wb25lbnQgfSBmcm9tICcuLi9hbmltYXRlZC1pY29uL2FuaW1hdGVkLWljb24uY29tcG9uZW50JztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnaG90LXRvYXN0JyxcbiAgdGVtcGxhdGVVcmw6ICdob3QtdG9hc3QuY29tcG9uZW50Lmh0bWwnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgaW1wb3J0czogW0NvbW1vbk1vZHVsZSwgRHluYW1pY1ZpZXdEaXJlY3RpdmUsIEluZGljYXRvckNvbXBvbmVudCwgQW5pbWF0ZWRJY29uQ29tcG9uZW50XSxcbn0pXG5leHBvcnQgY2xhc3MgSG90VG9hc3RDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSwgT25DaGFuZ2VzIHtcbiAgQElucHV0KCkgdG9hc3Q6IFRvYXN0PHVua25vd24+O1xuICBASW5wdXQoKSBvZmZzZXQgPSAwO1xuICBASW5wdXQoKSBkZWZhdWx0Q29uZmlnOiBUb2FzdENvbmZpZztcbiAgQElucHV0KCkgdG9hc3RSZWY6IENyZWF0ZUhvdFRvYXN0UmVmPHVua25vd24+O1xuICBwcml2YXRlIF90b2FzdHNBZnRlciA9IDA7XG4gIGdldCB0b2FzdHNBZnRlcigpIHtcbiAgICByZXR1cm4gdGhpcy5fdG9hc3RzQWZ0ZXI7XG4gIH1cbiAgQElucHV0KClcbiAgc2V0IHRvYXN0c0FmdGVyKHZhbHVlKSB7XG4gICAgdGhpcy5fdG9hc3RzQWZ0ZXIgPSB2YWx1ZTtcbiAgICBpZiAodGhpcy5kZWZhdWx0Q29uZmlnPy52aXNpYmxlVG9hc3RzID4gMCkge1xuICAgICAgaWYgKHRoaXMudG9hc3QuYXV0b0Nsb3NlKSB7XG4gICAgICAgIC8vIGlmICh2YWx1ZSA+PSB0aGlzLmRlZmF1bHRDb25maWc/LnZpc2libGVUb2FzdHMpIHtcbiAgICAgICAgLy8gICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIC8vIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh2YWx1ZSA+PSB0aGlzLmRlZmF1bHRDb25maWc/LnZpc2libGVUb2FzdHMpIHtcbiAgICAgICAgICB0aGlzLnNvZnRDbG9zZSgpO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuc29mdENsb3NlZCkge1xuICAgICAgICAgIHRoaXMuc29mdE9wZW4oKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuICBASW5wdXQoKSBpc1Nob3dpbmdBbGxUb2FzdHMgPSBmYWxzZTtcblxuICBAT3V0cHV0KCkgaGVpZ2h0ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gIEBPdXRwdXQoKSBiZWZvcmVDbG9zZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIEBPdXRwdXQoKSBhZnRlckNsb3NlZCA9IG5ldyBFdmVudEVtaXR0ZXI8SG90VG9hc3RDbG9zZT4oKTtcbiAgQE91dHB1dCgpIHNob3dBbGxUb2FzdHMgPSBuZXcgRXZlbnRFbWl0dGVyPGJvb2xlYW4+KCk7XG5cbiAgQFZpZXdDaGlsZCgnaG90VG9hc3RCYXJCYXNlJykgcHJpdmF0ZSB0b2FzdEJhckJhc2U6IEVsZW1lbnRSZWY8SFRNTEVsZW1lbnQ+O1xuXG4gIGlzTWFudWFsQ2xvc2UgPSBmYWxzZTtcbiAgY29udGV4dDogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgdG9hc3RDb21wb25lbnRJbmplY3RvcjogSW5qZWN0b3I7XG5cbiAgcHJpdmF0ZSB1bmxpc3RlbmVyczogVm9pZEZ1bmN0aW9uW10gPSBbXTtcbiAgcHJpdmF0ZSBzb2Z0Q2xvc2VkID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IsIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSkge31cblxuICBnZXQgdG9hc3RCYXJCYXNlSGVpZ2h0KCkge1xuICAgIHJldHVybiB0aGlzLnRvYXN0QmFyQmFzZS5uYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodDtcbiAgfVxuXG4gIGdldCBzY2FsZSgpIHtcbiAgICByZXR1cm4gdGhpcy5kZWZhdWx0Q29uZmlnLnN0YWNraW5nICE9PSAndmVydGljYWwnICYmICF0aGlzLmlzU2hvd2luZ0FsbFRvYXN0c1xuICAgICAgPyB0aGlzLnRvYXN0c0FmdGVyICogLUhPVF9UT0FTVF9ERVBUSF9TQ0FMRSArIDFcbiAgICAgIDogMTtcbiAgfVxuXG4gIGdldCB0cmFuc2xhdGVZKCkge1xuICAgIHJldHVybiB0aGlzLm9mZnNldCAqICh0aGlzLnRvcCA/IDEgOiAtMSkgKyAncHgnO1xuICB9XG5cbiAgZ2V0IGV4aXRBbmltYXRpb25EZWxheSgpIHtcbiAgICByZXR1cm4gdGhpcy50b2FzdC5kdXJhdGlvbiArICdtcyc7XG4gIH1cblxuICBnZXQgdG9wKCkge1xuICAgIHJldHVybiB0aGlzLnRvYXN0LnBvc2l0aW9uLmluY2x1ZGVzKCd0b3AnKTtcbiAgfVxuXG4gIGdldCBjb250YWluZXJQb3NpdGlvblN0eWxlKCkge1xuICAgIGNvbnN0IHZlcnRpY2FsU3R5bGUgPSB0aGlzLnRvcCA/IHsgdG9wOiAwIH0gOiB7IGJvdHRvbTogMCB9O1xuICAgIGNvbnN0IHRyYW5zZm9ybSA9IGB0cmFuc2xhdGVZKHZhcigtLWhvdC10b2FzdC10cmFuc2xhdGUteSkpIHNjYWxlKHZhcigtLWhvdC10b2FzdC1zY2FsZSkpYDtcblxuICAgIGNvbnN0IGhvcml6b250YWxTdHlsZSA9IHRoaXMudG9hc3QucG9zaXRpb24uaW5jbHVkZXMoJ2xlZnQnKVxuICAgICAgPyB7XG4gICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgfVxuICAgICAgOiB0aGlzLnRvYXN0LnBvc2l0aW9uLmluY2x1ZGVzKCdyaWdodCcpXG4gICAgICA/IHtcbiAgICAgICAgICByaWdodDogMCxcbiAgICAgICAgfVxuICAgICAgOiB7XG4gICAgICAgICAgbGVmdDogMCxcbiAgICAgICAgICByaWdodDogMCxcbiAgICAgICAgICBqdXN0aWZ5Q29udGVudDogJ2NlbnRlcicsXG4gICAgICAgIH07XG4gICAgcmV0dXJuIHtcbiAgICAgIHRyYW5zZm9ybSxcbiAgICAgIC4uLnZlcnRpY2FsU3R5bGUsXG4gICAgICAuLi5ob3Jpem9udGFsU3R5bGUsXG4gICAgfTtcbiAgfVxuXG4gIGdldCB0b2FzdEJhckJhc2VTdHlsZXMoKSB7XG4gICAgY29uc3QgZW50ZXJBbmltYXRpb24gPSBgaG90VG9hc3RFbnRlckFuaW1hdGlvbiR7XG4gICAgICB0aGlzLnRvcCA/ICdOZWdhdGl2ZScgOiAnUG9zaXRpdmUnXG4gICAgfSAke0VOVEVSX0FOSU1BVElPTl9EVVJBVElPTn1tcyBjdWJpYy1iZXppZXIoMC4yMSwgMS4wMiwgMC43MywgMSkgZm9yd2FyZHNgO1xuXG4gICAgY29uc3QgZXhpdEFuaW1hdGlvbiA9IGBob3RUb2FzdEV4aXRBbmltYXRpb24ke1xuICAgICAgdGhpcy50b3AgPyAnTmVnYXRpdmUnIDogJ1Bvc2l0aXZlJ1xuICAgIH0gJHtFWElUX0FOSU1BVElPTl9EVVJBVElPTn1tcyBmb3J3YXJkcyBjdWJpYy1iZXppZXIoMC4wNiwgMC43MSwgMC41NSwgMSkgdmFyKC0taG90LXRvYXN0LWV4aXQtYW5pbWF0aW9uLWRlbGF5KSB2YXIoLS1ob3QtdG9hc3QtZXhpdC1hbmltYXRpb24tc3RhdGUpYDtcblxuICAgIGNvbnN0IGFuaW1hdGlvbiA9IHRoaXMudG9hc3QuYXV0b0Nsb3NlID8gYCR7ZW50ZXJBbmltYXRpb259LCAke2V4aXRBbmltYXRpb259YCA6IGVudGVyQW5pbWF0aW9uO1xuXG4gICAgcmV0dXJuIHsgLi4udGhpcy50b2FzdC5zdHlsZSwgYW5pbWF0aW9uIH07XG4gIH1cblxuICBnZXQgaXNJY29uU3RyaW5nKCkge1xuICAgIHJldHVybiB0eXBlb2YgdGhpcy50b2FzdC5pY29uID09PSAnc3RyaW5nJztcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcbiAgICBpZiAoY2hhbmdlcy50b2FzdCAmJiAhY2hhbmdlcy50b2FzdC5maXJzdENoYW5nZSAmJiBjaGFuZ2VzLnRvYXN0LmN1cnJlbnRWYWx1ZT8ubWVzc2FnZSkge1xuICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgICAgdGhpcy5oZWlnaHQuZW1pdCh0aGlzLnRvYXN0QmFyQmFzZS5uYXRpdmVFbGVtZW50Lm9mZnNldEhlaWdodCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICBpZiAoaXNUZW1wbGF0ZVJlZih0aGlzLnRvYXN0Lm1lc3NhZ2UpKSB7XG4gICAgICB0aGlzLmNvbnRleHQgPSB7ICRpbXBsaWNpdDogdGhpcy50b2FzdFJlZiB9O1xuICAgIH1cbiAgICBpZiAoaXNDb21wb25lbnQodGhpcy50b2FzdC5tZXNzYWdlKSkge1xuICAgICAgdGhpcy50b2FzdENvbXBvbmVudEluamVjdG9yID0gSW5qZWN0b3IuY3JlYXRlKHtcbiAgICAgICAgcHJvdmlkZXJzOiBbXG4gICAgICAgICAge1xuICAgICAgICAgICAgcHJvdmlkZTogSG90VG9hc3RSZWYsXG4gICAgICAgICAgICB1c2VWYWx1ZTogdGhpcy50b2FzdFJlZixcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgICBwYXJlbnQ6IHRoaXMudG9hc3QuaW5qZWN0b3IgfHwgdGhpcy5pbmplY3RvcixcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICBjb25zdCBuYXRpdmVFbGVtZW50ID0gdGhpcy50b2FzdEJhckJhc2UubmF0aXZlRWxlbWVudDtcbiAgICAvLyBDYXJldGFrZXIgbm90ZTogYWNjZXNzaW5nIGBvZmZzZXRIZWlnaHRgIHRyaWdnZXJzIHRoZSB3aG9sZSBsYXlvdXQgdXBkYXRlLlxuICAgIC8vIE1hY3JvIHRhc2tzIChsaWtlIGBzZXRUaW1lb3V0YCkgbWlnaHQgYmUgZXhlY3V0ZWQgd2l0aGluIHRoZSBjdXJyZW50IHJlbmRlcmluZyBmcmFtZSBhbmQgY2F1c2UgYSBmcmFtZSBkcm9wLlxuICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XG4gICAgICB0aGlzLmhlaWdodC5lbWl0KG5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0KTtcbiAgICB9KTtcblxuICAgIC8vIENhcmV0YWtlciBub3RlOiBgYW5pbWF0aW9uc3RhcnRgIGFuZCBgYW5pbWF0aW9uZW5kYCBldmVudHMgYXJlIGV2ZW50IHRhc2tzIHRoYXQgdHJpZ2dlciBjaGFuZ2UgZGV0ZWN0aW9uLlxuICAgIC8vIFdlJ2Qgd2FudCB0byB0cmlnZ2VyIHRoZSBjaGFuZ2UgZGV0ZWN0aW9uIG9ubHkgaWYgaXQncyBhbiBleGl0IGFuaW1hdGlvbi5cbiAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLnVubGlzdGVuZXJzLnB1c2goXG4gICAgICAgIC8vIENhcmV0YWtlciBub3RlOiB3ZSBoYXZlIHRvIHJlbW92ZSB0aGVzZSBldmVudCBsaXN0ZW5lcnMgYXQgdGhlIGVuZCAoZXZlbiBpZiB0aGUgZWxlbWVudCBpcyByZW1vdmVkIGZyb20gRE9NKS5cbiAgICAgICAgLy8gem9uZS5qcyBzdG9yZXMgaXRzIGBab25lVGFza2BzIHdpdGhpbiB0aGUgYG5hdGl2ZUVsZW1lbnRbWm9uZS5fX3N5bWJvbF9fKCdhbmltYXRpb25zdGFydCcpICsgJ2ZhbHNlJ11gIHByb3BlcnR5XG4gICAgICAgIC8vIHdpdGggY2FsbGJhY2sgdGhhdCBjYXB0dXJlIGB0aGlzYC5cbiAgICAgICAgdGhpcy5yZW5kZXJlci5saXN0ZW4obmF0aXZlRWxlbWVudCwgJ2FuaW1hdGlvbnN0YXJ0JywgKGV2ZW50OiBBbmltYXRpb25FdmVudCkgPT4ge1xuICAgICAgICAgIGlmICh0aGlzLmlzRXhpdEFuaW1hdGlvbihldmVudCkpIHtcbiAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bigoKSA9PiB0aGlzLmJlZm9yZUNsb3NlZC5lbWl0KCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSksXG4gICAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKG5hdGl2ZUVsZW1lbnQsICdhbmltYXRpb25lbmQnLCAoZXZlbnQ6IEFuaW1hdGlvbkV2ZW50KSA9PiB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNFeGl0QW5pbWF0aW9uKGV2ZW50KSkge1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuKCgpID0+IHRoaXMuYWZ0ZXJDbG9zZWQuZW1pdCh7IGRpc21pc3NlZEJ5QWN0aW9uOiB0aGlzLmlzTWFudWFsQ2xvc2UsIGlkOiB0aGlzLnRvYXN0LmlkIH0pKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH0pO1xuXG4gICAgdGhpcy5zZXRUb2FzdEF0dHJpYnV0ZXMoKTtcbiAgfVxuXG4gIHNvZnRDbG9zZSgpIHtcbiAgICBjb25zdCBleGl0QW5pbWF0aW9uID0gYGhvdFRvYXN0RXhpdFNvZnRBbmltYXRpb24ke1xuICAgICAgdGhpcy50b3AgPyAnTmVnYXRpdmUnIDogJ1Bvc2l0aXZlJ1xuICAgIH0gJHtFWElUX0FOSU1BVElPTl9EVVJBVElPTn1tcyBmb3J3YXJkcyBjdWJpYy1iZXppZXIoMC4wNiwgMC43MSwgMC41NSwgMSlgO1xuXG4gICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBhbmltYXRlKG5hdGl2ZUVsZW1lbnQsIGV4aXRBbmltYXRpb24pO1xuICAgIHRoaXMuc29mdENsb3NlZCA9IHRydWU7XG4gIH1cbiAgc29mdE9wZW4oKSB7XG4gICAgY29uc3Qgc29mdEVudGVyQW5pbWF0aW9uID0gYGhvdFRvYXN0RW50ZXJTb2Z0QW5pbWF0aW9uJHtcbiAgICAgIHRvcCA/ICdOZWdhdGl2ZScgOiAnUG9zaXRpdmUnXG4gICAgfSAke0VOVEVSX0FOSU1BVElPTl9EVVJBVElPTn1tcyBjdWJpYy1iZXppZXIoMC4yMSwgMS4wMiwgMC43MywgMSkgZm9yd2FyZHNgO1xuXG4gICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBhbmltYXRlKG5hdGl2ZUVsZW1lbnQsIHNvZnRFbnRlckFuaW1hdGlvbik7XG4gICAgdGhpcy5zb2Z0Q2xvc2VkID0gZmFsc2U7XG4gIH1cblxuICBjbG9zZSgpIHtcbiAgICB0aGlzLmlzTWFudWFsQ2xvc2UgPSB0cnVlO1xuXG4gICAgY29uc3QgZXhpdEFuaW1hdGlvbiA9IGBob3RUb2FzdEV4aXRBbmltYXRpb24ke1xuICAgICAgdGhpcy50b3AgPyAnTmVnYXRpdmUnIDogJ1Bvc2l0aXZlJ1xuICAgIH0gJHtFWElUX0FOSU1BVElPTl9EVVJBVElPTn1tcyBmb3J3YXJkcyBjdWJpYy1iZXppZXIoMC4wNiwgMC43MSwgMC41NSwgMSlgO1xuXG4gICAgY29uc3QgbmF0aXZlRWxlbWVudCA9IHRoaXMudG9hc3RCYXJCYXNlLm5hdGl2ZUVsZW1lbnQ7XG5cbiAgICBhbmltYXRlKG5hdGl2ZUVsZW1lbnQsIGV4aXRBbmltYXRpb24pO1xuICB9XG5cbiAgaGFuZGxlTW91c2VFbnRlcigpIHtcbiAgICB0aGlzLnNob3dBbGxUb2FzdHMuZW1pdCh0cnVlKTtcbiAgfVxuICBoYW5kbGVNb3VzZUxlYXZlKCkge1xuICAgIHRoaXMuc2hvd0FsbFRvYXN0cy5lbWl0KGZhbHNlKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCkge1xuICAgIHRoaXMuY2xvc2UoKTtcbiAgICB3aGlsZSAodGhpcy51bmxpc3RlbmVycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMudW5saXN0ZW5lcnMucG9wKCkoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzRXhpdEFuaW1hdGlvbihldjogQW5pbWF0aW9uRXZlbnQpIHtcbiAgICByZXR1cm4gZXYuYW5pbWF0aW9uTmFtZS5pbmNsdWRlcygnaG90VG9hc3RFeGl0QW5pbWF0aW9uJyk7XG4gIH1cblxuICBwcml2YXRlIHNldFRvYXN0QXR0cmlidXRlcygpIHtcbiAgICBjb25zdCB0b2FzdEF0dHJpYnV0ZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB0aGlzLnRvYXN0LmF0dHJpYnV0ZXM7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModG9hc3RBdHRyaWJ1dGVzKSkge1xuICAgICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGhpcy50b2FzdEJhckJhc2UubmF0aXZlRWxlbWVudCwga2V5LCB2YWx1ZSk7XG4gICAgfVxuICB9XG59XG4iLCI8ZGl2XG4gIGNsYXNzPVwiaG90LXRvYXN0LWJhci1iYXNlLWNvbnRhaW5lclwiXG4gIFtuZ1N0eWxlXT1cImNvbnRhaW5lclBvc2l0aW9uU3R5bGVcIlxuICBbbmdDbGFzc109XCInaG90LXRvYXN0LXRoZW1lLScgKyB0b2FzdC50aGVtZVwiXG4gIFtzdHlsZS4tLWhvdC10b2FzdC1zY2FsZV09XCJzY2FsZVwiXG4gIFtzdHlsZS4tLWhvdC10b2FzdC10cmFuc2xhdGUteV09XCJ0cmFuc2xhdGVZXCJcbj5cbiAgPGRpdiBjbGFzcz1cImhvdC10b2FzdC1iYXItYmFzZS13cmFwcGVyXCIgKG1vdXNlZW50ZXIpPVwiaGFuZGxlTW91c2VFbnRlcigpXCIgKG1vdXNlbGVhdmUpPVwiaGFuZGxlTW91c2VMZWF2ZSgpXCI+XG4gICAgPGRpdlxuICAgICAgY2xhc3M9XCJob3QtdG9hc3QtYmFyLWJhc2VcIlxuICAgICAgI2hvdFRvYXN0QmFyQmFzZVxuICAgICAgW25nU3R5bGVdPVwidG9hc3RCYXJCYXNlU3R5bGVzXCJcbiAgICAgIFtuZ0NsYXNzXT1cInRvYXN0LmNsYXNzTmFtZVwiXG4gICAgICBbc3R5bGUuLS1ob3QtdG9hc3QtYW5pbWF0aW9uLXN0YXRlXT1cImlzTWFudWFsQ2xvc2UgPyAncnVubmluZycgOiAncGF1c2VkJ1wiXG4gICAgICBbc3R5bGUuLS1ob3QtdG9hc3QtZXhpdC1hbmltYXRpb24tc3RhdGVdPVwiaXNTaG93aW5nQWxsVG9hc3RzID8gJ3BhdXNlZCcgOiAncnVubmluZydcIlxuICAgICAgW3N0eWxlLi0taG90LXRvYXN0LWV4aXQtYW5pbWF0aW9uLWRlbGF5XT1cImV4aXRBbmltYXRpb25EZWxheVwiXG4gICAgICBbYXR0ci5hcmlhLWxpdmVdPVwidG9hc3QuYXJpYUxpdmVcIlxuICAgICAgW2F0dHIucm9sZV09XCJ0b2FzdC5yb2xlXCJcbiAgICA+XG4gICAgICA8ZGl2IGNsYXNzPVwiaG90LXRvYXN0LWljb25cIiBhcmlhLWhpZGRlbj1cInRydWVcIj5cbiAgICAgICAgQGlmICh0b2FzdC5pY29uICE9PSB1bmRlZmluZWQpIHsgQGlmIChpc0ljb25TdHJpbmcpIHtcbiAgICAgICAgPGhvdC10b2FzdC1hbmltYXRlZC1pY29uIFtpY29uVGhlbWVdPVwidG9hc3QuaWNvblRoZW1lXCI+e3sgdG9hc3QuaWNvbiB9fTwvaG90LXRvYXN0LWFuaW1hdGVkLWljb24+XG4gICAgICAgIH0gQGVsc2Uge1xuICAgICAgICA8ZGl2PlxuICAgICAgICAgIDxuZy1jb250YWluZXIgKmR5bmFtaWNWaWV3PVwidG9hc3QuaWNvblwiPjwvbmctY29udGFpbmVyPlxuICAgICAgICA8L2Rpdj5cbiAgICAgICAgfSB9IEBlbHNlIHtcbiAgICAgICAgPGhvdC10b2FzdC1pbmRpY2F0b3IgW3RoZW1lXT1cInRvYXN0Lmljb25UaGVtZVwiIFt0eXBlXT1cInRvYXN0LnR5cGVcIj48L2hvdC10b2FzdC1pbmRpY2F0b3I+XG4gICAgICAgIH1cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8ZGl2IGNsYXNzPVwiaG90LXRvYXN0LW1lc3NhZ2VcIj5cbiAgICAgICAgPGRpdj5cbiAgICAgICAgICA8bmctY29udGFpbmVyICpkeW5hbWljVmlldz1cInRvYXN0Lm1lc3NhZ2U7IGNvbnRleHQ6IGNvbnRleHQ7IGluamVjdG9yOiB0b2FzdENvbXBvbmVudEluamVjdG9yXCI+PC9uZy1jb250YWluZXI+XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9kaXY+XG5cbiAgICAgIEBpZiAodG9hc3QuZGlzbWlzc2libGUpIHtcbiAgICAgIDxidXR0b25cbiAgICAgICAgKGNsaWNrKT1cImNsb3NlKClcIlxuICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgY2xhc3M9XCJob3QtdG9hc3QtY2xvc2UtYnRuXCJcbiAgICAgICAgYXJpYS1sYWJlbD1cIkNsb3NlXCJcbiAgICAgICAgW25nU3R5bGVdPVwidG9hc3QuY2xvc2VTdHlsZVwiXG4gICAgICA+PC9idXR0b24+XG4gICAgICB9XG4gICAgPC9kaXY+XG4gIDwvZGl2PlxuPC9kaXY+XG4iXX0=